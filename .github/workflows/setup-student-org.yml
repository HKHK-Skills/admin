name: Setup Student Organization

on:
  workflow_dispatch:
    inputs:
      student_email:
        description: 'Student email (firstname.lastname@hkhk.edu.ee)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        type: boolean
        default: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate org name from email
        id: config
        env:
          TEACHERS_JSON: ${{ secrets.TEACHERS_JSON }}
          GROUPS_JSON: ${{ secrets.GROUPS_JSON }}
          STUDENTS_JSON: ${{ secrets.STUDENTS_JSON }}
          STUDENT_EMAIL: ${{ inputs.student_email }}
        run: |
          echo "$TEACHERS_JSON" > /tmp/teachers.json
          echo "$GROUPS_JSON" > /tmp/groups.json
          echo "$STUDENTS_JSON" > /tmp/students.json
          
          # Find student by email
          STUDENT=$(jq -r --arg e "$STUDENT_EMAIL" '.[] | select(.email == $e)' /tmp/students.json)
          
          if [ -z "$STUDENT" ] || [ "$STUDENT" == "null" ]; then
            echo "‚ùå Student with email $STUDENT_EMAIL not found"
            exit 1
          fi
          
          GROUP=$(echo "$STUDENT" | jq -r '.group')
          NAME=$(echo "$STUDENT" | jq -r '.name')
          
          echo "‚úÖ Student: $NAME"
          echo "   Email: $STUDENT_EMAIL"
          echo "   Group: $GROUP"
          
          # Generate org name from email: alex.kreimann@hkhk.edu.ee ‚Üí akreimann
          EMAIL_PREFIX=$(echo "$STUDENT_EMAIL" | cut -d'@' -f1)
          FIRSTNAME=$(echo "$EMAIL_PREFIX" | cut -d'.' -f1)
          LASTNAME=$(echo "$EMAIL_PREFIX" | cut -d'.' -f2)
          
          # Handle Estonian chars
          normalize() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | \
              sed 's/√§/a/g; s/√∂/o/g; s/√º/u/g; s/√µ/o/g; s/≈°/s/g; s/≈æ/z/g' | \
              tr -cd 'a-z0-9-'
          }
          
          FIRSTNAME_NORM=$(normalize "$FIRSTNAME")
          LASTNAME_NORM=$(normalize "$LASTNAME")
          INITIAL_NORM=$(echo "$FIRSTNAME_NORM" | cut -c1)
          
          ORG_NAME="${INITIAL_NORM}${LASTNAME_NORM}"
          
          echo "üìã Generated org name: $ORG_NAME"
          
          # Get subjects for this group
          SUBJECTS=$(jq -r --arg g "$GROUP" '.[$g].current_subjects' /tmp/groups.json)
          
          # Find OWNER teachers
          OWNERS=$(jq -c '[.[] | select(.role == "owner")]' /tmp/teachers.json)
          
          # Find ADMIN teachers
          ADMINS=$(jq -c --argjson subjs "$SUBJECTS" '
            [.[] | select(.role == "admin") | select(
              .subjects as $ts | ($subjs | any(. as $s | $ts | index($s)))
            )]
          ' /tmp/teachers.json)
          
          echo "org_name=$ORG_NAME" >> $GITHUB_OUTPUT
          echo "group=$GROUP" >> $GITHUB_OUTPUT
          echo "student_name=$NAME" >> $GITHUB_OUTPUT
          echo "firstname=$FIRSTNAME_NORM" >> $GITHUB_OUTPUT
          echo "lastname=$LASTNAME_NORM" >> $GITHUB_OUTPUT
          {
            echo "subjects<<EOF"
            echo "$SUBJECTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          {
            echo "owners<<EOF"
            echo "$OWNERS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          {
            echo "admins<<EOF"
            echo "$ADMINS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          rm /tmp/teachers.json /tmp/groups.json /tmp/students.json

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Check org availability
        id: check-org
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG_NAME: ${{ steps.config.outputs.org_name }}
          FIRSTNAME: ${{ steps.config.outputs.firstname }}
          LASTNAME: ${{ steps.config.outputs.lastname }}
        run: |
          check_org() {
            gh api "/orgs/$1" &>/dev/null && echo "taken" || echo "free"
          }
          
          if [ "$(check_org "$ORG_NAME")" == "free" ]; then
            echo "final_org=$ORG_NAME" >> $GITHUB_OUTPUT
            echo "‚úÖ Org available: $ORG_NAME"
            exit 0
          fi
          
          ALT1="${FIRSTNAME:0:2}${LASTNAME}"
          if [ "$(check_org "$ALT1")" == "free" ]; then
            echo "final_org=$ALT1" >> $GITHUB_OUTPUT
            echo "‚úÖ Org available: $ALT1"
            exit 0
          fi
          
          ALT2="${FIRSTNAME:0:3}${LASTNAME}"
          if [ "$(check_org "$ALT2")" == "free" ]; then
            echo "final_org=$ALT2" >> $GITHUB_OUTPUT
            echo "‚úÖ Org available: $ALT2"
            exit 0
          fi
          
          ALT3="${FIRSTNAME}${LASTNAME}"
          if [ "$(check_org "$ALT3")" == "free" ]; then
            echo "final_org=$ALT3" >> $GITHUB_OUTPUT
            echo "‚úÖ Org available: $ALT3"
            exit 0
          fi
          
          echo "‚ùå No available org name"
          exit 1

      - name: Dry run
        if: ${{ inputs.dry_run }}
        env:
          ORG: ${{ steps.check-org.outputs.final_org }}
          STUDENT_EMAIL: ${{ inputs.student_email }}
          STUDENT_NAME: ${{ steps.config.outputs.student_name }}
          GROUP: ${{ steps.config.outputs.group }}
          SUBJECTS: ${{ steps.config.outputs.subjects }}
          OWNERS: ${{ steps.config.outputs.owners }}
          ADMINS: ${{ steps.config.outputs.admins }}
        run: |
          echo "üîç DRY RUN"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìã ORG: $ORG"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üë§ STUDENT"
          echo "   Email: $STUDENT_EMAIL"
          echo "   Group: $GROUP"
          echo "   Invite: EMAIL"
          echo ""
          echo "üëë OWNERS"
          echo "$OWNERS" | jq -r '.[] | "   - \(.github)"'
          echo ""
          echo "üë®‚Äçüè´ ADMINS"
          echo "$ADMINS" | jq -r '.[] | "   - \(.github) [\(.subjects | join(", "))]"'
          echo ""
          echo "üìÅ REPOS"
          echo "$SUBJECTS" | jq -r '.[]' | while read -r subj; do
            REPO=$(jq -r --arg s "$subj" '.[$s].material_repo' config/subjects.json)
            echo "   - ${REPO}-labs"
          done
          echo "   - portfolio"

      - name: Setup org (LIVE)
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: ${{ steps.check-org.outputs.final_org }}
          STUDENT_EMAIL: ${{ inputs.student_email }}
          SUBJECTS: ${{ steps.config.outputs.subjects }}
          OWNERS: ${{ steps.config.outputs.owners }}
          ADMINS: ${{ steps.config.outputs.admins }}
        run: |
          echo "üöÄ Setting up $ORG"
          
          if ! gh api "/orgs/$ORG" &>/dev/null; then
            echo "‚ùå Org $ORG does not exist!"
            echo "üëâ Create manually: https://github.com/organizations/new"
            echo "   Name: $ORG"
            exit 1
          fi
          
          invite_by_username() {
            local user=$1
            local role=$2
            local user_id=$(gh api "/users/$user" --jq '.id' 2>/dev/null)
            
            gh api -X POST "/orgs/$ORG/invitations" \
              -f invitee_id="$user_id" \
              -f role="$role" \
              2>/dev/null && echo "   ‚úÖ $user ‚Üí $role" || echo "   ‚ö†Ô∏è $user"
          }
          
          echo ""
          echo "üëë Inviting OWNERS"
          echo "$OWNERS" | jq -r '.[].github' | while read -r user; do
            invite_by_username "$user" "admin"
          done
          
          echo ""
          echo "üë®‚Äçüè´ Inviting ADMINS"  
          echo "$ADMINS" | jq -r '.[].github' | while read -r user; do
            invite_by_username "$user" "admin"
          done
          
          echo ""
          echo "üë§ Inviting STUDENT (email)"
          gh api -X POST "/orgs/$ORG/invitations" \
            -f email="$STUDENT_EMAIL" \
            -f role="direct_member" \
            2>/dev/null && echo "   ‚úÖ $STUDENT_EMAIL" || echo "   ‚ö†Ô∏è failed"
          
          echo ""
          echo "üìÅ Creating REPOS"
          echo "$SUBJECTS" | jq -r '.[]' | while read -r subj; do
            REPO=$(jq -r --arg s "$subj" '.[$s].material_repo' config/subjects.json)
            gh repo create "$ORG/$REPO-labs" --private --add-readme 2>/dev/null && echo "   ‚úÖ $REPO-labs" || echo "   ‚ö†Ô∏è $REPO-labs"
          done
          gh repo create "$ORG/portfolio" --private --add-readme 2>/dev/null && echo "   ‚úÖ portfolio" || echo "   ‚ö†Ô∏è portfolio"
          
          echo ""
          echo "‚úÖ Done: https://github.com/$ORG"
