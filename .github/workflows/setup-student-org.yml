name: Setup Student Organization

on:
  workflow_dispatch:
    inputs:
      student_github:
        description: 'Student GitHub username'
        required: true
        type: string
      org_name:
        description: 'Student org name (e.g., HKHK-jaan-tamm)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        type: boolean
        default: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ inputs.org_name }}

      - name: Load config
        id: config
        env:
          STUDENTS_JSON: ${{ secrets.STUDENTS_JSON }}
          TEACHERS_JSON: ${{ secrets.TEACHERS_JSON }}
          GROUPS_JSON: ${{ secrets.GROUPS_JSON }}
          STUDENT_GITHUB: ${{ inputs.student_github }}
        run: |
          # Save to temp
          echo "$STUDENTS_JSON" > /tmp/students.json
          echo "$TEACHERS_JSON" > /tmp/teachers.json
          echo "$GROUPS_JSON" > /tmp/groups.json
          
          # Find student
          STUDENT=$(jq -r --arg gh "$STUDENT_GITHUB" '.[] | select(.github == $gh)' /tmp/students.json)
          
          if [ -z "$STUDENT" ] || [ "$STUDENT" == "null" ]; then
            echo "âŒ Student $STUDENT_GITHUB not found"
            exit 1
          fi
          
          GROUP=$(echo "$STUDENT" | jq -r '.group')
          echo "âœ… Student: $STUDENT_GITHUB, Group: $GROUP"
          
          # Get subjects for this group
          SUBJECTS=$(jq -r --arg g "$GROUP" '.[$g].current_subjects' /tmp/groups.json)
          echo "ðŸ“š Subjects: $SUBJECTS"
          
          # Find OWNER teachers (role: owner)
          OWNERS=$(jq -c '[.[] | select(.role == "owner")]' /tmp/teachers.json)
          echo "ðŸ‘‘ Owners: $OWNERS"
          
          # Find ADMIN teachers (subjects match group's current_subjects)
          ADMINS=$(jq -c --argjson subjs "$SUBJECTS" '
            [.[] | select(.role == "admin") | select(
              .subjects as $ts | ($subjs | any(. as $s | $ts | index($s)))
            )]
          ' /tmp/teachers.json)
          echo "ðŸ‘¨â€ðŸ« Admins: $ADMINS"
          
          # Set outputs
          echo "group=$GROUP" >> $GITHUB_OUTPUT
          {
            echo "subjects<<EOF"
            echo "$SUBJECTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          {
            echo "owners<<EOF"
            echo "$OWNERS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          {
            echo "admins<<EOF"
            echo "$ADMINS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          rm /tmp/students.json /tmp/teachers.json /tmp/groups.json

      - name: Dry run
        if: ${{ inputs.dry_run }}
        env:
          ORG: ${{ inputs.org_name }}
          STUDENT: ${{ inputs.student_github }}
          GROUP: ${{ steps.config.outputs.group }}
          SUBJECTS: ${{ steps.config.outputs.subjects }}
          OWNERS: ${{ steps.config.outputs.owners }}
          ADMINS: ${{ steps.config.outputs.admins }}
        run: |
          echo "ðŸ” DRY RUN - $ORG"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ STUDENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   GitHub: $STUDENT"
          echo "   Group: $GROUP"
          echo "   Org role: member"
          echo "   Repo role: write"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘‘ OWNERS (org: owner)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$OWNERS" | jq -r '.[] | "   - \(.github)"'
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘¨â€ðŸ« ADMINS (org: admin, repo: admin)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$ADMINS" | jq -r '.[] | "   - \(.github) [\(.subjects | join(", "))]"'
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ REPOS (student: write, teachers: admin)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$SUBJECTS" | jq -r '.[]' | while read -r subj; do
            REPO=$(jq -r --arg s "$subj" '.[$s].material_repo' config/subjects.json)
            NAME=$(jq -r --arg s "$subj" '.[$s].name' config/subjects.json)
            echo "   - ${REPO}-labs ($NAME)"
          done
          echo "   - portfolio"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š PERMISSION MATRIX"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "   â”‚ User        â”‚ Org Role  â”‚ Repo Role â”‚"
          echo "   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "$OWNERS" | jq -r '.[] | "   â”‚ \(.github | .[0:11])  â”‚ owner     â”‚ admin     â”‚"'
          echo "$ADMINS" | jq -r '.[] | "   â”‚ \(.github | .[0:11])  â”‚ admin     â”‚ admin     â”‚"'
          echo "   â”‚ $STUDENT  â”‚ member    â”‚ write     â”‚"
          echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

      - name: Setup org
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: ${{ inputs.org_name }}
          STUDENT: ${{ inputs.student_github }}
          SUBJECTS: ${{ steps.config.outputs.subjects }}
          OWNERS: ${{ steps.config.outputs.owners }}
          ADMINS: ${{ steps.config.outputs.admins }}
        run: |
          echo "ðŸš€ Setting up $ORG"
          echo ""
          
          # Get user IDs
          get_user_id() {
            gh api "/users/$1" --jq '.id' 2>/dev/null || echo ""
          }
          
          # Invite with role
          invite_user() {
            local user=$1
            local role=$2
            local user_id=$(get_user_id "$user")
            
            if [ -z "$user_id" ]; then
              echo "   âš ï¸ User $user not found"
              return 1
            fi
            
            gh api -X POST "/orgs/$ORG/invitations" \
              -f invitee_id="$user_id" \
              -f role="$role" \
              2>/dev/null && echo "   âœ… $user â†’ $role" || echo "   âš ï¸ $user (exists/pending)"
          }
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘‘ Inviting OWNERS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$OWNERS" | jq -r '.[].github' | while read -r user; do
            invite_user "$user" "admin"  # owner via API = admin + manual promote
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘¨â€ðŸ« Inviting ADMINS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$ADMINS" | jq -r '.[].github' | while read -r user; do
            invite_user "$user" "admin"
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘¤ Inviting STUDENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          invite_user "$STUDENT" "direct_member"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ Creating REPOS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          create_repo() {
            local name=$1
            local desc=$2
            
            gh repo create "$ORG/$name" \
              --private \
              --description "$desc" \
              --add-readme \
              2>/dev/null && echo "   âœ… $name" || echo "   âš ï¸ $name (exists)"
            
            # Set student write permission
            gh api -X PUT "/repos/$ORG/$name/collaborators/$STUDENT" \
              -f permission="push" \
              2>/dev/null || true
          }
          
          echo "$SUBJECTS" | jq -r '.[]' | while read -r subj; do
            REPO=$(jq -r --arg s "$subj" '.[$s].material_repo' config/subjects.json)
            NAME=$(jq -r --arg s "$subj" '.[$s].name' config/subjects.json)
            create_repo "${REPO}-labs" "Lab: $NAME"
          done
          
          create_repo "portfolio" "Professional portfolio"
          
          echo ""
          echo "âœ… Setup complete!"
          echo ""
          echo "ðŸ“‹ Summary:"
          echo "   Org: https://github.com/$ORG"
          echo "   Owners: $(echo "$OWNERS" | jq -r '[.[].github] | join(", ")')"
          echo "   Admins: $(echo "$ADMINS" | jq -r '[.[].github] | join(", ")')"
          echo "   Student: $STUDENT"
