name: Setup Student Organization

on:
  workflow_dispatch:
    inputs:
      student_github:
        description: 'Student GitHub username'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        type: boolean
        default: true

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load config and generate org name
        id: config
        env:
          STUDENTS_JSON: ${{ secrets.STUDENTS_JSON }}
          TEACHERS_JSON: ${{ secrets.TEACHERS_JSON }}
          GROUPS_JSON: ${{ secrets.GROUPS_JSON }}
          STUDENT_GITHUB: ${{ inputs.student_github }}
        run: |
          # Save to temp
          echo "$STUDENTS_JSON" > /tmp/students.json
          echo "$TEACHERS_JSON" > /tmp/teachers.json
          echo "$GROUPS_JSON" > /tmp/groups.json
          
          # Find student
          STUDENT=$(jq -r --arg gh "$STUDENT_GITHUB" '.[] | select(.github == $gh)' /tmp/students.json)
          
          if [ -z "$STUDENT" ] || [ "$STUDENT" == "null" ]; then
            echo "âŒ Student $STUDENT_GITHUB not found"
            exit 1
          fi
          
          # Get student info
          EMAIL=$(echo "$STUDENT" | jq -r '.email')
          GROUP=$(echo "$STUDENT" | jq -r '.group')
          NAME=$(echo "$STUDENT" | jq -r '.name // empty')
          
          echo "âœ… Student: $STUDENT_GITHUB"
          echo "   Email: $EMAIL"
          echo "   Group: $GROUP"
          
          # Generate org name from email: alex.kreimann@hkhk.edu.ee â†’ akreimann
          # Format: first initial + lastname
          EMAIL_PREFIX=$(echo "$EMAIL" | cut -d'@' -f1)  # alex.kreimann
          FIRSTNAME=$(echo "$EMAIL_PREFIX" | cut -d'.' -f1)  # alex
          LASTNAME=$(echo "$EMAIL_PREFIX" | cut -d'.' -f2)   # kreimann
          INITIAL=$(echo "$FIRSTNAME" | cut -c1)             # a
          
          # Generate org name: akreimann
          ORG_NAME="${INITIAL}${LASTNAME}"
          
          # Normalize: lowercase, remove special chars
          ORG_NAME=$(echo "$ORG_NAME" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9-')
          
          echo "ðŸ“‹ Generated org name: $ORG_NAME"
          
          # Get subjects for this group
          SUBJECTS=$(jq -r --arg g "$GROUP" '.[$g].current_subjects' /tmp/groups.json)
          
          # Find OWNER teachers
          OWNERS=$(jq -c '[.[] | select(.role == "owner")]' /tmp/teachers.json)
          
          # Find ADMIN teachers (subjects match)
          ADMINS=$(jq -c --argjson subjs "$SUBJECTS" '
            [.[] | select(.role == "admin") | select(
              .subjects as $ts | ($subjs | any(. as $s | $ts | index($s)))
            )]
          ' /tmp/teachers.json)
          
          # Set outputs
          echo "org_name=$ORG_NAME" >> $GITHUB_OUTPUT
          echo "group=$GROUP" >> $GITHUB_OUTPUT
          echo "email=$EMAIL" >> $GITHUB_OUTPUT
          echo "firstname=$FIRSTNAME" >> $GITHUB_OUTPUT
          echo "lastname=$LASTNAME" >> $GITHUB_OUTPUT
          {
            echo "subjects<<EOF"
            echo "$SUBJECTS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          {
            echo "owners<<EOF"
            echo "$OWNERS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          {
            echo "admins<<EOF"
            echo "$ADMINS"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          rm /tmp/students.json /tmp/teachers.json /tmp/groups.json

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ steps.config.outputs.org_name }}

      - name: Check org availability
        id: check-org
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG_NAME: ${{ steps.config.outputs.org_name }}
          FIRSTNAME: ${{ steps.config.outputs.firstname }}
          LASTNAME: ${{ steps.config.outputs.lastname }}
        run: |
          # Check if org exists
          check_org() {
            gh api "/orgs/$1" &>/dev/null && echo "taken" || echo "free"
          }
          
          # Try original: akreimann
          if [ "$(check_org "$ORG_NAME")" == "free" ]; then
            echo "final_org=$ORG_NAME" >> $GITHUB_OUTPUT
            echo "âœ… Org available: $ORG_NAME"
            exit 0
          fi
          
          echo "âš ï¸ $ORG_NAME is taken, trying alternatives..."
          
          # Try with 2 chars: alkreimann
          ALT1="${FIRSTNAME:0:2}${LASTNAME}"
          if [ "$(check_org "$ALT1")" == "free" ]; then
            echo "final_org=$ALT1" >> $GITHUB_OUTPUT
            echo "âœ… Org available: $ALT1"
            exit 0
          fi
          
          # Try with 3 chars: alekreimann
          ALT2="${FIRSTNAME:0:3}${LASTNAME}"
          if [ "$(check_org "$ALT2")" == "free" ]; then
            echo "final_org=$ALT2" >> $GITHUB_OUTPUT
            echo "âœ… Org available: $ALT2"
            exit 0
          fi
          
          # Try full name: alexkreimann
          ALT3="${FIRSTNAME}${LASTNAME}"
          if [ "$(check_org "$ALT3")" == "free" ]; then
            echo "final_org=$ALT3" >> $GITHUB_OUTPUT
            echo "âœ… Org available: $ALT3"
            exit 0
          fi
          
          echo "âŒ No available org name found"
          exit 1

      - name: Dry run
        if: ${{ inputs.dry_run }}
        env:
          ORG: ${{ steps.check-org.outputs.final_org }}
          STUDENT: ${{ inputs.student_github }}
          GROUP: ${{ steps.config.outputs.group }}
          SUBJECTS: ${{ steps.config.outputs.subjects }}
          OWNERS: ${{ steps.config.outputs.owners }}
          ADMINS: ${{ steps.config.outputs.admins }}
        run: |
          echo "ðŸ” DRY RUN"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ ORG: $ORG"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘¤ STUDENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   GitHub: $STUDENT"
          echo "   Group: $GROUP"
          echo "   Org role: member"
          echo "   Repo role: write"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘‘ OWNERS (org: owner)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$OWNERS" | jq -r '.[] | "   - \(.github)"'
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘¨â€ðŸ« ADMINS (org: admin)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$ADMINS" | jq -r '.[] | "   - \(.github) [\(.subjects | join(", "))]"'
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ REPOS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$SUBJECTS" | jq -r '.[]' | while read -r subj; do
            REPO=$(jq -r --arg s "$subj" '.[$s].material_repo' config/subjects.json)
            NAME=$(jq -r --arg s "$subj" '.[$s].name' config/subjects.json)
            echo "   - ${REPO}-labs ($NAME)"
          done
          echo "   - portfolio"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š PERMISSION MATRIX"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          printf "   %-20s %-12s %-12s\n" "User" "Org Role" "Repo Role"
          printf "   %-20s %-12s %-12s\n" "--------------------" "------------" "------------"
          echo "$OWNERS" | jq -r '.[] | .github' | while read -r u; do
            printf "   %-20s %-12s %-12s\n" "$u" "owner" "admin"
          done
          echo "$ADMINS" | jq -r '.[] | .github' | while read -r u; do
            printf "   %-20s %-12s %-12s\n" "$u" "admin" "admin"
          done
          printf "   %-20s %-12s %-12s\n" "$STUDENT" "member" "write"

      - name: Setup org
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: ${{ steps.check-org.outputs.final_org }}
          STUDENT: ${{ inputs.student_github }}
          SUBJECTS: ${{ steps.config.outputs.subjects }}
          OWNERS: ${{ steps.config.outputs.owners }}
          ADMINS: ${{ steps.config.outputs.admins }}
        run: |
          echo "ðŸš€ Setting up $ORG"
          
          get_user_id() {
            gh api "/users/$1" --jq '.id' 2>/dev/null || echo ""
          }
          
          invite_user() {
            local user=$1
            local role=$2
            local user_id=$(get_user_id "$user")
            
            if [ -z "$user_id" ]; then
              echo "   âš ï¸ User $user not found"
              return 1
            fi
            
            gh api -X POST "/orgs/$ORG/invitations" \
              -f invitee_id="$user_id" \
              -f role="$role" \
              2>/dev/null && echo "   âœ… $user â†’ $role" || echo "   âš ï¸ $user (exists/pending)"
          }
          
          echo ""
          echo "ðŸ‘‘ Inviting OWNERS"
          echo "$OWNERS" | jq -r '.[].github' | while read -r user; do
            invite_user "$user" "admin"
          done
          
          echo ""
          echo "ðŸ‘¨â€ðŸ« Inviting ADMINS"
          echo "$ADMINS" | jq -r '.[].github' | while read -r user; do
            invite_user "$user" "admin"
          done
          
          echo ""
          echo "ðŸ‘¤ Inviting STUDENT"
          invite_user "$STUDENT" "direct_member"
          
          echo ""
          echo "ðŸ“ Creating REPOS"
          
          create_repo() {
            local name=$1
            local desc=$2
            
            gh repo create "$ORG/$name" \
              --private \
              --description "$desc" \
              --add-readme \
              2>/dev/null && echo "   âœ… $name" || echo "   âš ï¸ $name (exists)"
            
            gh api -X PUT "/repos/$ORG/$name/collaborators/$STUDENT" \
              -f permission="push" \
              2>/dev/null || true
          }
          
          echo "$SUBJECTS" | jq -r '.[]' | while read -r subj; do
            REPO=$(jq -r --arg s "$subj" '.[$s].material_repo' config/subjects.json)
            NAME=$(jq -r --arg s "$subj" '.[$s].name' config/subjects.json)
            create_repo "${REPO}-labs" "Lab: $NAME"
          done
          
          create_repo "portfolio" "Professional portfolio"
          
          echo ""
          echo "âœ… Setup complete: https://github.com/$ORG"
