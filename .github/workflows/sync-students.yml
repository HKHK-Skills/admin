# Sync Students from Secret
#
# SEADISTAMINE:
# 1. Secret: STUDENTS_JSON (v√µi STUDENTS_JSON_TEST)
# 2. Secret: APP_PRIVATE_KEY  
# 3. Variable: APP_ID

name: Sync Students

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run'
        default: 'true'
        type: choice
        options: ['true', 'false']
      use_test_data:
        description: 'Use test data (STUDENTS_JSON_TEST)'
        default: 'false'
        type: choice
        options: ['true', 'false']

env:
  ORG_NAME: HKHK-Skills
  TEAM_PREFIX: students

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Load data
        env:
          STUDENTS_JSON: ${{ secrets.STUDENTS_JSON }}
          STUDENTS_JSON_TEST: ${{ secrets.STUDENTS_JSON_TEST }}
        run: |
          if [ "${{ inputs.use_test_data }}" == "true" ]; then
            echo "üìã Using TEST data"
            echo "$STUDENTS_JSON_TEST" > data.json
          else
            echo "üìã Using PRODUCTION data"
            echo "$STUDENTS_JSON" > data.json
          fi
          echo "‚úÖ $(jq '.students | length' data.json) students, $(jq '.teachers | length' data.json) teachers"
          jq -r '.students[].group' data.json 2>/dev/null | sort -u > groups.txt || touch groups.txt

      - name: Dry run
        if: inputs.dry_run == 'true'
        run: |
          echo "üîç DRY RUN"
          echo "Teams:"
          while read -r G; do [ -z "$G" ] && continue; echo "  - ${TEAM_PREFIX}-$(echo $G | tr '[:upper:]' '[:lower:]')"; done < groups.txt
          echo "  - teachers"
          echo ""
          echo "Invites: $(jq '.students | length' data.json) students + $(jq '.teachers | length' data.json) teachers"
          echo ""
          echo "üìß Emails:"
          jq -r '.students[].email' data.json 2>/dev/null || true
          jq -r '.teachers[].email' data.json 2>/dev/null || true

      - name: Get token
        id: token
        if: inputs.dry_run != 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ env.ORG_NAME }}

      - name: Create teams & invite
        if: inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          # Teams
          while read -r G; do
            [ -z "$G" ] && continue
            T="${TEAM_PREFIX}-$(echo $G | tr '[:upper:]' '[:lower:]')"
            gh api "orgs/${ORG_NAME}/teams" -f name="$T" -f privacy="closed" 2>/dev/null && echo "‚úÖ Team: $T" || echo "‚ÑπÔ∏è Team exists: $T"
          done < groups.txt
          gh api "orgs/${ORG_NAME}/teams" -f name="teachers" -f privacy="closed" 2>/dev/null && echo "‚úÖ Team: teachers" || echo "‚ÑπÔ∏è Team exists: teachers"
          
          # Students
          jq -c '.students[]' data.json 2>/dev/null | while read -r S; do
            EMAIL=$(echo "$S" | jq -r '.email')
            T="${TEAM_PREFIX}-$(echo $(echo "$S" | jq -r '.group') | tr '[:upper:]' '[:lower:]')"
            TID=$(gh api "orgs/${ORG_NAME}/teams/${T}" --jq '.id' 2>/dev/null || echo "")
            if [ -n "$TID" ]; then
              gh api "orgs/${ORG_NAME}/invitations" -f email="$EMAIL" -f role="direct_member" --field team_ids[]="$TID" 2>/dev/null && echo "‚úÖ Invited: $EMAIL" || echo "‚è≠Ô∏è Already invited: $EMAIL"
            fi
            sleep 0.3
          done
          
          # Teachers
          TID=$(gh api "orgs/${ORG_NAME}/teams/teachers" --jq '.id' 2>/dev/null || echo "")
          jq -r '.teachers[].email' data.json 2>/dev/null | while read -r E; do
            if [ -n "$TID" ] && [ -n "$E" ]; then
              gh api "orgs/${ORG_NAME}/invitations" -f email="$E" -f role="direct_member" --field team_ids[]="$TID" 2>/dev/null && echo "‚úÖ Invited: $E" || echo "‚è≠Ô∏è Already invited: $E"
            fi
            sleep 0.3
          done
